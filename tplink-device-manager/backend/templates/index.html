<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TP-Link è®¾å¤‡ç®¡ç†å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .login-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 2fr 2fr 1fr 1fr;
            gap: 10px;
            align-items: end;
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-warning {
            background: #f39c12;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .control-panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: none;
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status.connected {
            background: #d4edda;
            color: #155724;
        }

        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .devices-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
        }

        .devices-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .devices-table th,
        .devices-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .devices-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .devices-table tr:hover {
            background: #f8f9fa;
        }

        .device-name {
            font-weight: 500;
            color: #2c3e50;
        }

        .device-name-unnamed {
            font-weight: 400;
            color: #e67e22;
            font-style: italic;
        }

        .device-mac {
            font-family: monospace;
            font-size: 12px;
            color: #7f8c8d;
        }

        .device-ip {
            color: #27ae60;
        }

        .input-group {
            display: flex;
            gap: 5px;
        }

        .input-group input {
            flex: 1;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 12px;
        }

        .input-group .btn {
            padding: 5px 10px;
            font-size: 12px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            margin: 50px auto;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #2c3e50;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .results-table th,
        .results-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #eee;
            font-size: 12px;
        }

        .success {
            color: #27ae60;
            font-weight: 500;
        }

        .error {
            color: #e74c3c;
            font-weight: 500;
        }

        .alert {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .switch {
            position: relative;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #3498db;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            background: #3498db;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
            display: inline-block;
        }

        .file-input-label:hover {
            background: #2980b9;
        }

        /* è¿›åº¦æ¡æ ·å¼ */
        .progress-container {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .progress-title {
            font-weight: 600;
            color: #2c3e50;
        }

        .progress-percentage {
            font-weight: 500;
            color: #3498db;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #f1f3f4;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background-color: #3498db;
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-details {
            font-size: 14px;
            color: #7f8c8d;
        }

        .progress-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 5px;
            font-size: 14px;
        }

        .progress-status.success {
            background: #d4edda;
            color: #155724;
        }

        .progress-status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .progress-status.warning {
            background: #fff3cd;
            color: #856404;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .devices-table {
                font-size: 12px;
            }

            .devices-table th,
            .devices-table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>ğŸ”§ TP-Link è®¾å¤‡ç®¡ç†å™¨</h1>
            <p>æ‰¹é‡ç®¡ç†æ‚¨çš„TP-Linkè·¯ç”±å™¨è¿æ¥è®¾å¤‡</p>
        </div>

        <!-- ç™»å½•åŒºåŸŸ -->
        <div class="login-section" id="loginSection">
            <h3>ç™»å½•è·¯ç”±å™¨</h3>
            <form id="loginForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="host">è·¯ç”±å™¨åœ°å€</label>
                        <input type="text" id="host" placeholder="192.168.1.1" value="192.168.1.1" required>
                    </div>
                    <div class="form-group">
                        <label for="password">ç™»å½•å¯†ç </label>
                        <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç " required>
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="submit" class="btn" id="loginBtn">ç™»å½•</button>
                    </div>
                </div>
            </form>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="control-panel" id="controlPanel">
            <div class="controls">
                <span class="status connected" id="connectionStatus">å·²è¿æ¥</span>
                <button class="btn" onclick="refreshDevices()">ğŸ”„ åˆ·æ–°è®¾å¤‡</button>
                <button class="btn btn-success" onclick="exportDevices()">ğŸ“¥ å¯¼å‡ºCSV</button>
                <div class="file-input-wrapper">
                    <input type="file" id="csvFile" accept=".csv" onchange="importDevices()">
                    <label for="csvFile" class="file-input-label">ğŸ“¤ å¯¼å…¥CSV</label>
                </div>

                <!-- ç­›é€‰æ§ä»¶ -->
                <select id="filterSelect" onchange="filterDevices()" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <option value="all">ğŸ“± æ‰€æœ‰è®¾å¤‡</option>
                    <option value="unnamed">ğŸ” æœªå‘½åè®¾å¤‡</option>
                    <option value="custom">âœï¸ å·²å‘½åè®¾å¤‡</option>
                </select>

                <!-- æ’åºæ§ä»¶ -->
                <select id="sortSelect" onchange="sortDevices()" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <option value="name">æŒ‰åç§°æ’åº</option>
                    <option value="mac">æŒ‰MACæ’åº</option>
                    <option value="ip">æŒ‰IPæ’åº</option>
                    <option value="type">æŒ‰ç±»å‹æ’åº</option>
                </select>

                <div class="auto-refresh">
                    <label class="switch">
                        <input type="checkbox" id="autoRefresh" onchange="toggleAutoRefresh()">
                        <span class="slider"></span>
                    </label>
                    <span>è‡ªåŠ¨åˆ·æ–° (10ç§’)</span>
                </div>
            </div>
        </div>

        <!-- è¿›åº¦æ˜¾ç¤º -->
        <div class="progress-container" id="progressContainer">
            <div class="progress-header">
                <div class="progress-title">ğŸ“¤ æ‰¹é‡æ›´æ–°è®¾å¤‡åç§°</div>
                <div class="progress-percentage" id="progressPercentage">0%</div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-details" id="progressDetails">å‡†å¤‡å¼€å§‹...</div>
            <div class="progress-status" id="progressStatus" style="display: none;"></div>
        </div>

        <!-- è®¾å¤‡åˆ—è¡¨ -->
        <div class="devices-section" id="devicesSection">
            <h3>è¿æ¥è®¾å¤‡åˆ—è¡¨ <span id="deviceCount" style="color: #3498db; font-size: 16px;"></span></h3>
            <table class="devices-table">
                <thead>
                    <tr>
                        <th>è®¾å¤‡åç§°</th>
                        <th>MACåœ°å€</th>
                        <th>IPåœ°å€</th>
                        <th>è¿æ¥ç±»å‹</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="devicesTableBody">
                    <!-- è®¾å¤‡æ•°æ®å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- ç»“æœæ¨¡æ€æ¡† -->
    <div class="modal" id="resultsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ‰¹é‡æ“ä½œç»“æœ</h3>
            </div>
            <div id="resultsContent"></div>
            <button class="btn" onclick="closeModal()" style="margin-top: 20px;">å…³é—­</button>
        </div>
    </div>

    <script>
        let currentDevices = [];
        let autoRefreshInterval = null;

        // ç™»å½•åŠŸèƒ½
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const host = document.getElementById('host').value;
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');

            loginBtn.disabled = true;
            loginBtn.textContent = 'ç™»å½•ä¸­...';

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ host, password })
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert('ç™»å½•æˆåŠŸï¼', 'success');
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('controlPanel').style.display = 'block';
                    document.getElementById('devicesSection').style.display = 'block';
                    refreshDevices();
                } else {
                    let errorMsg = result.error || 'æœªçŸ¥é”™è¯¯';

                    // æä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œè§£å†³å»ºè®®
                    if (errorMsg.includes('401') || errorMsg.includes('Unauthorized')) {
                        errorMsg = `ç™»å½•å¤±è´¥ï¼šå¯†ç é”™è¯¯æˆ–éœ€è¦ä½¿ç”¨åŠ å¯†å¯†ç 

ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼š
1. ç¡®è®¤ä½¿ç”¨çš„æ˜¯è·¯ç”±å™¨Webç™»å½•å¯†ç ï¼ˆä¸æ˜¯TP-Link IDå¯†ç ï¼‰
2. æŸäº›è·¯ç”±å™¨éœ€è¦ä½¿ç”¨åŠ å¯†å¯†ç ï¼Œè·å–æ–¹æ³•ï¼š
   - æµè§ˆå™¨æ‰“å¼€è·¯ç”±å™¨ç™»å½•é¡µé¢
   - è¾“å…¥å¯†ç åç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹
   - æŒ‰F12æ‰“å¼€æ§åˆ¶å°ï¼Œè¾“å…¥ï¼šdocument.getElementById('login-password').value
   - ä½¿ç”¨è¿”å›çš„åŠ å¯†å­—ç¬¦ä¸²ä½œä¸ºå¯†ç `;
                    }

                    showAlert(errorMsg, 'error');
                }
            } catch (error) {
                showAlert('ç™»å½•å¤±è´¥ï¼š' + error.message, 'error');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'ç™»å½•';
            }
        });

        // è·å–è®¾å¤‡åˆ—è¡¨
        async function refreshDevices() {
            try {
                const filterType = document.getElementById('filterSelect').value;
                const sortBy = document.getElementById('sortSelect').value;

                const response = await fetch(`/api/devices?filter=${filterType}&sort=${sortBy}`);
                const result = await response.json();

                if (response.ok) {
                    currentDevices = result.devices;
                    displayDevices(currentDevices);
                } else {
                    showAlert('è·å–è®¾å¤‡åˆ—è¡¨å¤±è´¥ï¼š' + result.error, 'error');
                }
            } catch (error) {
                showAlert('è·å–è®¾å¤‡åˆ—è¡¨å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ç­›é€‰è®¾å¤‡
        function filterDevices() {
            refreshDevices();
        }

        // æ’åºè®¾å¤‡
        function sortDevices() {
            refreshDevices();
        }

        // æ˜¾ç¤ºè®¾å¤‡åˆ—è¡¨
        function displayDevices(devices) {
            const tbody = document.getElementById('devicesTableBody');
            const deviceCount = document.getElementById('deviceCount');
            const filterType = document.getElementById('filterSelect').value;

            // æ›´æ–°è®¾å¤‡æ€»æ•°å’Œç­›é€‰ä¿¡æ¯
            let filterText = '';
            if (filterType === 'unnamed') {
                filterText = ' (æœªå‘½å)';
            } else if (filterType === 'custom') {
                filterText = ' (å·²å‘½å)';
            }
            deviceCount.textContent = `(å…± ${devices.length} ä¸ªè®¾å¤‡${filterText})`;

            if (devices.length === 0) {
                let emptyMessage = 'æš‚æ— è¿æ¥è®¾å¤‡';
                if (filterType === 'unnamed') {
                    emptyMessage = 'âœ… æ­å–œï¼æ‰€æœ‰è®¾å¤‡éƒ½å·²å‘½å';
                } else if (filterType === 'custom') {
                    emptyMessage = 'æš‚æ— å·²å‘½åçš„è®¾å¤‡';
                }
                tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 20px; color: #7f8c8d;">${emptyMessage}</td></tr>`;
                return;
            }

            tbody.innerHTML = devices.map(device => {
                // åˆ¤æ–­æ˜¯å¦ä¸ºæœªå‘½åè®¾å¤‡
                const isUnnamed = device.name === device.mac_address;
                const nameClass = isUnnamed ? 'device-name-unnamed' : 'device-name';
                const nameIcon = isUnnamed ? 'ğŸ”' : 'âœï¸';

                return `
                    <tr>
                        <td class="${nameClass}">${nameIcon} ${device.name}</td>
                        <td class="device-mac">${device.mac_address}</td>
                        <td class="device-ip">${device.ip_address}</td>
                        <td>${device.connection_type || 'N/A'}</td>
                        <td>
                            <div class="input-group">
                                <input type="text" id="name-${device.mac_address}"
                                       value="${device.name}" placeholder="è¾“å…¥æ–°åç§°">
                                <button class="btn btn-success" onclick="updateDeviceName('${device.mac_address}')">
                                    ä¿®æ”¹
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ä¿®æ”¹å•ä¸ªè®¾å¤‡åç§°
        async function updateDeviceName(macAddress) {
            const newName = document.getElementById(`name-${macAddress}`).value.trim();

            if (!newName) {
                showAlert('è¯·è¾“å…¥è®¾å¤‡åç§°', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/device/${macAddress}/name`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name: newName })
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert('è®¾å¤‡åç§°ä¿®æ”¹æˆåŠŸï¼', 'success');
                    refreshDevices();
                } else {
                    showAlert('ä¿®æ”¹å¤±è´¥ï¼š' + result.error, 'error');
                }
            } catch (error) {
                showAlert('ä¿®æ”¹å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // å¯¼å‡ºè®¾å¤‡åˆ—è¡¨
        async function exportDevices() {
            try {
                const response = await fetch('/api/devices/export');

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = response.headers.get('Content-Disposition').split('filename=')[1].replace(/"/g, '');
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    showAlert('è®¾å¤‡åˆ—è¡¨å¯¼å‡ºæˆåŠŸï¼', 'success');
                } else {
                    const result = await response.json();
                    showAlert('å¯¼å‡ºå¤±è´¥ï¼š' + result.error, 'error');
                }
            } catch (error) {
                showAlert('å¯¼å‡ºå¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // å¯¼å…¥CSVæ–‡ä»¶
        async function importDevices() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];

            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
                // æ˜¾ç¤ºè¿›åº¦æ¡
                showProgress();

                const response = await fetch('/api/devices/import', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    updateProgress(0, result.summary?.updates_attempted || 0, 'å¼€å§‹æ‰¹é‡æ›´æ–°...');

                    // å¼€å§‹è½®è¯¢è¿›åº¦
                    const progressInterval = setInterval(async () => {
                        try {
                            const progressResponse = await fetch('/api/progress');
                            const progressData = await progressResponse.json();

                            updateProgress(
                                progressData.current,
                                progressData.total,
                                `æ­£åœ¨ä¿®æ”¹è®¾å¤‡: ${progressData.latest_result?.new_name || 'æœªçŸ¥è®¾å¤‡'}`,
                                progressData.latest_result
                            );

                            if (progressData.completed) {
                                clearInterval(progressInterval);

                                if (progressData.error) {
                                    showProgressError(progressData.error);
                                } else {
                                    showProgressSuccess();
                                    // è·å–æœ€ç»ˆç»“æœ
                                    const finalResults = await fetch('/api/progress');
                                    const finalData = await finalResults.json();

                                    setTimeout(() => {
                                        hideProgress();
                                        showAlert('æ‰¹é‡æ›´æ–°å®Œæˆï¼', 'success');
                                        showResults(finalData.results);
                                        refreshDevices();
                                    }, 2000);
                                }
                            }
                        } catch (error) {
                            clearInterval(progressInterval);
                            showProgressError('è·å–è¿›åº¦å¤±è´¥ï¼š' + error.message);
                            setTimeout(() => hideProgress(), 3000);
                        }
                    }, 1000); // æ¯ç§’æ›´æ–°ä¸€æ¬¡è¿›åº¦

                } else {
                    hideProgress();
                    showAlert('å¯¼å…¥å¤±è´¥ï¼š' + result.error, 'error');
                }
            } catch (error) {
                hideProgress();
                showAlert('å¯¼å…¥å¤±è´¥ï¼š' + error.message, 'error');
            }

            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
            fileInput.value = '';
        }

        // æ˜¾ç¤ºè¿›åº¦æ¡
        function showProgress() {
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('progressPercentage').textContent = '0%';
            document.getElementById('progressDetails').textContent = 'å‡†å¤‡å¼€å§‹...';
            document.getElementById('progressStatus').style.display = 'none';
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress(current, total, details, latestResult) {
            const percentage = total > 0 ? Math.round((current / total) * 100) : 0;
            const progressFill = document.getElementById('progressFill');
            const progressPercentage = document.getElementById('progressPercentage');
            const progressDetails = document.getElementById('progressDetails');

            progressFill.style.width = percentage + '%';
            progressPercentage.textContent = percentage + '%';

            if (details) {
                if (latestResult) {
                    const status = latestResult.success ? 'âœ…' : 'âŒ';
                    const name = latestResult.new_name || 'æœªçŸ¥è®¾å¤‡';
                    progressDetails.innerHTML = `${status} æ­£åœ¨å¤„ç†: ${name} (${current}/${total})`;
                } else {
                    progressDetails.textContent = `${details} (${current}/${total})`;
                }
            }
        }

        // æ˜¾ç¤ºè¿›åº¦æˆåŠŸ
        function showProgressSuccess() {
            const progressStatus = document.getElementById('progressStatus');
            progressStatus.className = 'progress-status success';
            progressStatus.textContent = 'ğŸ‰ æ‰¹é‡æ›´æ–°å®Œæˆï¼';
            progressStatus.style.display = 'block';
        }

        // æ˜¾ç¤ºè¿›åº¦é”™è¯¯
        function showProgressError(error) {
            const progressStatus = document.getElementById('progressStatus');
            progressStatus.className = 'progress-status error';
            progressStatus.textContent = 'âŒ ' + error;
            progressStatus.style.display = 'block';
        }

        // éšè—è¿›åº¦æ¡
        function hideProgress() {
            document.getElementById('progressContainer').style.display = 'none';
        }

        // æ˜¾ç¤ºæ‰¹é‡æ“ä½œç»“æœ
        function showResults(results) {
            const modal = document.getElementById('resultsModal');
            const content = document.getElementById('resultsContent');

            const successCount = results.filter(r => r.success).length;
            const errorCount = results.filter(r => !r.success).length;

            let html = `
                <p><strong>å¤„ç†å®Œæˆï¼š</strong>æˆåŠŸ ${successCount} ä¸ªï¼Œå¤±è´¥ ${errorCount} ä¸ª</p>
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>MACåœ°å€</th>
                            <th>æ–°åç§°</th>
                            <th>ç»“æœ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            results.forEach(result => {
                const statusClass = result.success ? 'success' : 'error';
                const statusText = result.success ? 'æˆåŠŸ' : 'å¤±è´¥';
                html += `
                    <tr>
                        <td class="device-mac">${result.mac_address}</td>
                        <td>${result.new_name}</td>
                        <td class="${statusClass}">${statusText}</td>
                    </tr>
                `;
                if (result.error) {
                    html += `<tr><td colspan="3" class="error">${result.error}</td></tr>`;
                }
            });

            html += '</tbody></table>';
            content.innerHTML = html;
            modal.style.display = 'block';
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('resultsModal').style.display = 'none';
        }

        // åˆ‡æ¢è‡ªåŠ¨åˆ·æ–°
        function toggleAutoRefresh() {
            const checkbox = document.getElementById('autoRefresh');

            if (checkbox.checked) {
                autoRefreshInterval = setInterval(refreshDevices, 10000);
                showAlert('å·²å¼€å¯è‡ªåŠ¨åˆ·æ–°ï¼ˆ10ç§’ï¼‰', 'success');
            } else {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                showAlert('å·²å…³é—­è‡ªåŠ¨åˆ·æ–°', 'success');
            }
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(message, type) {
            // ç§»é™¤ç°æœ‰çš„æç¤º
            const existingAlert = document.querySelector('.alert');
            if (existingAlert) {
                existingAlert.remove();
            }

            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;

            document.querySelector('.container').insertBefore(alert, document.querySelector('.container').firstChild);

            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 3000);
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„ç™»å½•ä¿¡æ¯
            const savedHost = localStorage.getItem('tplink_host');
            if (savedHost) {
                document.getElementById('host').value = savedHost;
            }

            // ç›‘å¬è·¯ç”±å™¨åœ°å€å˜åŒ–
            document.getElementById('host').addEventListener('change', function() {
                localStorage.setItem('tplink_host', this.value);
            });
        });

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('resultsModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>